<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Details - ZIKRIYA DARBAR FOOD PRODUCTS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script>
      tailwind.config = {
        theme: { extend: { fontFamily: { sans: ["Poppins", "sans-serif"] } } },
      };

      const API_BASE = location.hostname.includes("zdspices.pk")
        ? "https://api.zdspices.pk"
        : `http://${location.hostname}:5000`;
    </script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
      }
      .carousel-img {
        transition: transform 0.3s ease;
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #e5e7eb;
        display: block;
      }
      .carousel-img:hover {
        transform: scale(1.05);
      }
      .carousel-container {
        width: 100%;
        height: 500px;
        background: #e5e7eb;
        position: relative;
        overflow: hidden;
      }
      .loading-spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .stock-bar {
        transition: width 0.3s ease;
      }
      .price-animate {
        animation: pulse 0.5s ease-in-out;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
      .product-image-section {
        min-height: 500px;
      }
      .toast {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Mobile menu button fix */
      .mobile-menu-btn {
        background: transparent;
        border: none;
        padding: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mobile-menu-btn:hover {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }

      /* Mobile menu smooth */
      #mobileMenu {
        transition: max-height 0.3s ease-in-out;
        max-height: 0;
        overflow: hidden;
      }

      #mobileMenu:not(.hidden) {
        max-height: 500px;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Navbar -->
    <nav
      class="fixed top-0 w-full bg-white/95 backdrop-blur-md shadow-lg z-50 transition-all duration-300"
    >
      <div class="mx-auto px-0">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center space-x-6 pl-4 md:pl-8">
            <img
              src="/images/logo.jpeg"
              alt="Logo"
              class="h-24 w-24 object-contain rounded-full shadow-2xl border-4 border-orange-500 ring-4 ring-orange-200"
              onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23f97316%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2224%22 fill=%22white%22%3EZD%3C/text%3E%3C/svg%3E';"
            />
            <h1
              class="text-2xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-600 via-orange-500 to-yellow-600 tracking-wide"
            >
              ZIKRIYA DARBAR FOOD PRODUCTS
            </h1>
          </div>
          <div class="hidden md:flex items-center space-x-8 pr-4 md:pr-8">
            <a
              href="index.html"
              class="text-gray-700 hover:text-orange-600 font-medium transition duration-300 text-lg"
              >Home</a
            >
            <a
              href="index.html#products"
              class="text-gray-700 hover:text-orange-600 font-medium transition duration-300 text-lg"
              >Products</a
            >
            <a
              href="About.html"
              class="text-gray-700 hover:text-orange-600 font-medium transition duration-300 text-lg"
              >About Us</a
            >
            <a
              href="contact.html"
              class="text-gray-700 hover:text-orange-600 font-medium transition duration-300 text-lg"
              >Contact Us</a
            >
          </div>
          <div class="md:hidden flex items-center space-x-4 pr-4">
            <button
              onclick="toggleMobileMenu()"
              class="mobile-menu-btn"
              id="mobileMenuBtn"
            >
              <i class="fas fa-bars text-2xl text-gray-700"></i>
            </button>
          </div>
        </div>
        <div
          id="mobileMenu"
          class="hidden md:hidden absolute top-full left-0 w-full bg-white/98 backdrop-blur-lg shadow-2xl"
        >
          <div class="flex flex-col items-center py-8 space-y-6">
            <a
              href="index.html"
              class="text-xl font-medium text-gray-700 hover:text-orange-600 transition"
              onclick="closeMobileMenu()"
              >Home</a
            >
            <a
              href="index.html#products"
              class="text-xl font-medium text-gray-700 hover:text-orange-600 transition"
              onclick="closeMobileMenu()"
              >Products</a
            >
            <a
              href="About.html"
              class="text-xl font-medium text-gray-700 hover:text-orange-600 transition"
              onclick="closeMobileMenu()"
              >About Us</a
            >
            <a
              href="contact.html"
              class="text-xl font-medium text-gray-700 hover:text-orange-600 transition"
              onclick="closeMobileMenu()"
              >Contact Us</a
            >
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-28 pb-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div id="loadingSpinner" class="text-center py-10">
          <i
            class="fas fa-spinner loading-spinner text-3xl text-blue-500 mb-2"
          ></i>
          <p class="text-gray-600">Loading product details...</p>
        </div>
        <div id="productContent" class="hidden grid md:grid-cols-2 gap-8 mb-8">
          <!-- Carousel -->
          <div
            class="product-image-section relative rounded-xl overflow-hidden shadow-xl"
          >
            <div id="carousel" class="carousel-container"></div>
            <div
              id="thumbsContainer"
              class="flex justify-center mt-4 space-x-2 flex-wrap"
            ></div>
            <button
              onclick="prevSlide()"
              class="absolute left-2 top-1/2 -translate-y-1/2 bg-white p-2 rounded-full shadow-lg hover:bg-gray-100 z-10"
            >
              <i class="fas fa-chevron-left"></i>
            </button>
            <button
              onclick="nextSlide()"
              class="absolute right-2 top-1/2 -translate-y-1/2 bg-white p-2 rounded-full shadow-lg hover:bg-gray-100 z-10"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <!-- Info -->
          <div class="space-y-6 flex flex-col justify-center">
            <h1 id="productName" class="text-3xl font-bold text-gray-800"></h1>
            <p
              id="productDescription"
              class="text-gray-600 leading-relaxed"
            ></p>
            <div class="flex items-center space-x-4">
              <span class="text-yellow-500">
                <i class="fas fa-star"></i><i class="fas fa-star"></i
                ><i class="fas fa-star"></i><i class="fas fa-star"></i
                ><i class="far fa-star"></i> (4.5)
              </span>
              <span class="text-gray-500">12 reviews</span>
            </div>
            <div class="space-y-3">
              <div class="flex items-center space-x-2">
                <span
                  id="productPrice"
                  class="text-3xl font-bold text-green-600 price-animate"
                ></span>
                <span
                  id="productDiscount"
                  class="text-gray-400 line-through text-lg"
                ></span>
              </div>
              <div class="bg-blue-50 p-4 rounded-lg">
                <p class="text-sm text-gray-700 mb-2">Stock Availability</p>
                <div class="w-full bg-gray-200 rounded-full h-3">
                  <div
                    id="stockBar"
                    class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full stock-bar"
                  ></div>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                  <span id="productStock"></span> (
                  <span id="maxStock"></span> units available)
                </p>
              </div>
            </div>

            <!-- Quantity & Actions -->
            <div class="space-y-4">
              <div
                class="flex items-center space-x-4 bg-gray-50 p-4 rounded-lg"
              >
                <span class="text-sm font-semibold text-gray-700"
                  >Quantity:</span
                >
                <button
                  id="decBtn"
                  onclick="changeQty(-1)"
                  class="px-4 py-2 bg-gray-300 rounded disabled:opacity-50"
                >
                  <i class="fas fa-minus"></i>
                </button>
                <span
                  id="qtyInput"
                  class="text-lg font-bold bg-white px-6 py-2 rounded border"
                  >1</span
                >
                <button
                  id="incBtn"
                  onclick="changeQty(1)"
                  class="px-4 py-2 bg-gray-300 rounded disabled:opacity-50"
                >
                  <i class="fas fa-plus"></i>
                </button>
              </div>

              <div
                id="stockWarning"
                class="hidden bg-orange-50 border-l-4 border-orange-400 p-4"
              >
                <p class="text-orange-700 text-sm">
                  âš ï¸ Limited stock! Only
                  <span id="warningMaxStock"></span> units available.
                </p>
              </div>

              <button
                onclick="buyNow()"
                class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-4 rounded-lg text-lg font-bold hover:from-red-700 hover:to-orange-700 transition shadow-lg"
              >
                <i class="fas fa-shopping-cart mr-2"></i>Buy Now
              </button>
            </div>

            <!-- Product Details -->
            <div
              class="bg-gray-50 p-4 rounded-lg text-sm text-gray-600 space-y-2"
            >
              <p>
                <strong class="text-gray-800">Category:</strong>
                <span id="productCategory"></span>
              </p>
              <p>
                <strong class="text-gray-800">Delivery:</strong> 2-3 days
                nationwide
              </p>
              <p>
                <strong class="text-gray-800">Packaging:</strong> Freshly packed
                & sealed
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Buy Modal -->
    <div
      id="buyModal"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Confirm Order</h2>
        <form id="buyForm" class="space-y-4">
          <input
            type="text"
            id="buyerName"
            placeholder="Your Name"
            required
            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500"
          />
          <input
            type="tel"
            id="buyerPhone"
            placeholder="Phone Number (03XX-XXXXXXX)"
            required
            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500"
          />
          <textarea
            id="buyerAddress"
            placeholder="Delivery Address"
            required
            rows="3"
            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500"
          ></textarea>

          <div class="bg-blue-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Total Amount</p>
            <p id="totalAmount" class="text-2xl font-bold text-green-600"></p>
          </div>

          <div class="flex space-x-4">
            <button
              type="button"
              onclick="closeBuyModal()"
              class="flex-1 px-4 py-3 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400 transition"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
            >
              Place Order
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bill Modal -->
    <div
      id="billModal"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">
          Order Confirmation
        </h2>
        <div
          id="billContent"
          class="space-y-4 mb-6 max-h-96 overflow-y-auto"
        ></div>
        <div class="flex space-x-4">
          <button
            onclick="closeBillModal()"
            class="flex-1 px-4 py-3 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400 transition"
          >
            Close
          </button>
          <button
            onclick="printBill()"
            class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition"
          >
            <i class="fas fa-print mr-2"></i>Print
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-lg font-bold mb-4">ZIKRIYA DARBAR FOOD PRODUCTS</h3>
            <p class="text-gray-400">
              Premium spices & fish for B2B. Fresh, authentic, delivered fast.
            </p>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
            <ul class="space-y-2 text-gray-400">
              <li>
                <a href="index.html" class="hover:text-white transition"
                  >Home</a
                >
              </li>
              <li>
                <a
                  href="index.html#products"
                  class="hover:text-white transition"
                  >Products</a
                >
              </li>
              <li>
                <a href="About.html" class="hover:text-white transition"
                  >About Us</a
                >
              </li>
              <li>
                <a href="contact.html" class="hover:text-white transition"
                  >Contact</a
                >
              </li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Support</h4>
            <ul class="space-y-2 text-gray-400">
              <li><a href="#" class="hover:text-white transition">FAQ</a></li>
              <li>
                <a href="#" class="hover:text-white transition">Shipping</a>
              </li>
              <li>
                <a href="#" class="hover:text-white transition">Returns</a>
              </li>
              <li>
                <a href="#" class="hover:text-white transition"
                  >Privacy Policy</a
                >
              </li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Follow Us</h4>
            <div class="flex space-x-4">
              <a href="#" class="text-gray-400 hover:text-white transition"
                ><i class="fab fa-facebook-f text-xl"></i
              ></a>
              <a href="#" class="text-gray-400 hover:text-white transition"
                ><i class="fab fa-instagram text-xl"></i
              ></a>
              <a href="#" class="text-gray-400 hover:text-white transition"
                ><i class="fab fa-twitter text-xl"></i
              ></a>
            </div>
            <p class="text-sm text-gray-400 mt-4">
              Contact: 03327372364 | Email: zdspices@gmail.com
            </p>
          </div>
        </div>
        <div
          class="border-t border-gray-700 mt-8 pt-4 text-center text-gray-400"
        >
          <p>
            &copy; 2025 ZIKRIYA DARBAR FOOD PRODUCTS. All rights reserved. |
            Made with â¤ï¸ in Pakistan
          </p>
        </div>
      </div>
    </footer>

    <script>
      let currentProduct = null;
      let currentSlide = 0;
      let qty = 1;

      // Mobile Menu Functions
      function toggleMobileMenu() {
        const menu = document.getElementById("mobileMenu");
        const btn = document.getElementById("mobileMenuBtn");
        menu.classList.toggle("hidden");

        if (menu.classList.contains("hidden")) {
          btn.innerHTML = '<i class="fas fa-bars text-2xl text-gray-700"></i>';
        } else {
          btn.innerHTML = '<i class="fas fa-times text-2xl text-gray-700"></i>';
        }
      }

      function closeMobileMenu() {
        const menu = document.getElementById("mobileMenu");
        const btn = document.getElementById("mobileMenuBtn");
        menu.classList.add("hidden");
        btn.innerHTML = '<i class="fas fa-bars text-2xl text-gray-700"></i>';
      }

      // Close menu when clicking outside
      document.addEventListener("click", function (e) {
        const menu = document.getElementById("mobileMenu");
        const btn = document.getElementById("mobileMenuBtn");

        if (!menu.contains(e.target) && !btn.contains(e.target)) {
          if (!menu.classList.contains("hidden")) {
            closeMobileMenu();
          }
        }
      });

      // Get image URL with proper fallback
      function getImageUrl(img) {
        if (!img)
          return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500'%3E%3Crect width='500' height='500' fill='%23e5e7eb'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='24' fill='%239ca3af'%3ENo Image%3C/text%3E%3C/svg%3E";

        const imgStr = String(img).trim();

        if (imgStr.startsWith("data:image")) return imgStr;
        if (imgStr.startsWith("http")) return imgStr;
        if (imgStr)
          return `${API_BASE}${imgStr.startsWith("/") ? imgStr : "/" + imgStr}`;

        return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500'%3E%3Crect width='500' height='500' fill='%23e5e7eb'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='24' fill='%239ca3af'%3ENo Image%3C/text%3E%3C/svg%3E";
      }

      // Load product from URL
      async function loadProduct() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");

        if (!id) {
          document.getElementById("loadingSpinner").innerHTML =
            '<p class="text-red-600 text-xl">Product not found</p>';
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/api/products/${id}`);
          if (!res.ok) throw new Error("Product not found");

          currentProduct = await res.json();
          document.title = `${currentProduct.name} - ZIKRIYA DARBAR`;

          renderProduct();
        } catch (err) {
          console.error(err);
          document.getElementById("loadingSpinner").innerHTML =
            '<p class="text-red-600 text-xl">Error loading product</p>';
        }
      }

      function renderProduct() {
        document.getElementById("loadingSpinner").classList.add("hidden");
        document.getElementById("productContent").classList.remove("hidden");

        document.getElementById("productName").textContent =
          currentProduct.name;
        document.getElementById("productCategory").textContent =
          currentProduct.category || "General";
        document.getElementById("productDescription").innerHTML =
          currentProduct.description
            ? currentProduct.description.replace(/\n/g, "<br>")
            : "No description";

        const price = currentProduct.price || 0;
        const discount = currentProduct.discount || 0;
        const discountedPrice = price * (1 - discount / 100);

        document.getElementById(
          "productPrice"
        ).textContent = `Rs ${discountedPrice.toFixed(0)}`;
        document.getElementById("productDiscount").textContent =
          discount > 0 ? `Rs ${price.toFixed(0)}` : "";

        const stock = currentProduct.stock || 0;
        const stockPercent = stock > 0 ? Math.min((stock / 100) * 100, 100) : 0;
        document.getElementById("stockBar").style.width = stockPercent + "%";
        document.getElementById("productStock").textContent =
          stock > 0 ? "In Stock" : "Out of Stock";
        document.getElementById("maxStock").textContent = stock;

        loadCarousel();
        updateQtyButtons();
      }

      function loadCarousel() {
        const images =
          currentProduct.images && currentProduct.images.length > 0
            ? currentProduct.images.map((img) => getImageUrl(img))
            : [
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500'%3E%3Crect width='500' height='500' fill='%23e5e7eb'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='24' fill='%239ca3af'%3ENo Image%3C/text%3E%3C/svg%3E",
              ];

        const carousel = document.getElementById("carousel");
        const thumbs = document.getElementById("thumbsContainer");

        carousel.innerHTML = images
          .map(
            (img, i) => `
          <img src="${img}" alt="Product" class="carousel-img absolute inset-0" style="display: ${
              i === 0 ? "block" : "none"
            };" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22500%22 height=%22500%22%3E%3Crect width=%22500%22 height=%22500%22 fill=%22%23e5e7eb%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2224%22 fill=%22%239ca3af%22%3ENo Image%3C/text%3E%3C/svg%3E';">
        `
          )
          .join("");

        thumbs.innerHTML = images
          .map(
            (img, i) => `
          <img src="${img}" onclick="goToSlide(${i})" class="w-16 h-16 object-cover rounded cursor-pointer border-2 ${
              i === 0 ? "border-blue-500" : "border-gray-200"
            }" onerror="this.style.backgroundColor='#e5e7eb';">
        `
          )
          .join("");
      }

      function goToSlide(index) {
        document
          .querySelectorAll("#carousel img")
          .forEach(
            (img, i) => (img.style.display = i === index ? "block" : "none")
          );
        document
          .querySelectorAll("#thumbsContainer img")
          .forEach((thumb, i) => {
            thumb.classList.toggle("border-blue-500", i === index);
            thumb.classList.toggle("border-gray-200", i !== index);
          });
        currentSlide = index;
      }

      function prevSlide() {
        const len = currentProduct.images ? currentProduct.images.length : 1;
        goToSlide((currentSlide - 1 + len) % len);
      }

      function nextSlide() {
        const len = currentProduct.images ? currentProduct.images.length : 1;
        goToSlide((currentSlide + 1) % len);
      }

      function changeQty(change) {
        const newQty = qty + change;
        if (newQty < 1 || newQty > currentProduct.stock) return;
        qty = newQty;
        document.getElementById("qtyInput").textContent = qty;
        updateQtyButtons();
      }

      function updateQtyButtons() {
        document.getElementById("incBtn").disabled =
          qty >= currentProduct.stock;
        document.getElementById("decBtn").disabled = qty <= 1;
        document
          .getElementById("stockWarning")
          .classList.toggle("hidden", qty < currentProduct.stock);
      }

      function buyNow() {
        if (qty > currentProduct.stock) {
          alert("Insufficient stock!");
          return;
        }

        const finalPrice =
          currentProduct.price * (1 - currentProduct.discount / 100) * qty;
        document.getElementById("totalAmount").textContent =
          finalPrice.toFixed(0);
        document.getElementById("buyModal").classList.remove("hidden");
      }

      function closeBuyModal() {
        document.getElementById("buyModal").classList.add("hidden");
        document.getElementById("buyForm").reset();
      }

      document
        .getElementById("buyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const buyer = {
            name: document.getElementById("buyerName").value.trim(),
            phone: document.getElementById("buyerPhone").value.trim(),
            address: document.getElementById("buyerAddress").value.trim(),
          };

          if (!buyer.name || !buyer.phone || !buyer.address) {
            alert("Please fill all fields");
            return;
          }

          const subtotal =
            currentProduct.price * (1 - currentProduct.discount / 100) * qty;
          const total = subtotal;

          try {
            const res = await fetch(`${API_BASE}/api/orders`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                productId: currentProduct._id,
                buyer,
                qty,
                subtotal,
                gst: 0,
                delivery: 0,
                total,
              }),
            });

            if (!res.ok) throw new Error("Order failed");

            const data = await res.json();
            const order = data.order || data;

            closeBuyModal();

            alert(
              "âœ… Order Confirmed!\n\nOrder ID: #" +
                (order._id ? order._id.slice(-6) : "N/A") +
                "\n\nYour order has been placed successfully. You will receive it within 2-3 days."
            );

            showBill(order, total);
            confetti({
              particleCount: 100,
              spread: 70,
              origin: { y: 0.6 },
            });
          } catch (err) {
            alert("âŒ Order failed: " + err.message);
          }
        });

      function showBill(order, totalAmount) {
        const date = new Date().toLocaleDateString("en-PK");
        const buyerInfo = order.buyer || {};
        const billHtml = `
          <p><strong>Order Confirmation</strong></p>
          <p>ID: #${order._id ? order._id.slice(-6) : "N/A"}</p>
          <p>Date: ${date}</p>
          <table class="w-full mb-4 text-sm">
            <tr><td class="p-2">Product</td><td class="p-2 text-right">${
              currentProduct.name
            }</td></tr>
            <tr><td class="p-2">Qty</td><td class="p-2 text-right">${qty}</td></tr>
            <tr><td class="p-2 font-bold">Total</td><td class="p-2 text-right text-green-600">Rs ${totalAmount.toFixed(
              0
            )}</td></tr>
          </table>
          <div class="text-sm text-gray-600 border-t pt-2">
            <p><strong>Buyer Details:</strong></p>
            <p>Name: ${buyerInfo.name || "N/A"}</p>
            <p>Phone: ${buyerInfo.phone || "N/A"}</p>
            <p>Address: ${buyerInfo.address || "N/A"}</p>
            <p style="margin-top: 10px;"><strong>Status:</strong> Pending</p>
            <p><strong>Delivery:</strong> 2-3 days</p>
          </div>
        `;
        document.getElementById("billContent").innerHTML = billHtml;
        document.getElementById("billModal").classList.remove("hidden");
      }

      function closeBillModal() {
        document.getElementById("billModal").classList.add("hidden");
      }

      function printBill() {
        window.print();
      }

      // Load product on page load
      loadProduct();
    </script>
  </body>
</html>
